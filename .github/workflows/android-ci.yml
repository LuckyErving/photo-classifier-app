name: Android CI/CD

on:
  push:
    # branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'
    
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: '8.0'
        cache-read-only: false
    
    - name: Build with Gradle
      run: gradle build --parallel --build-cache --configuration-cache
      
    - name: Run tests
      run: gradle test --parallel --build-cache
      
    - name: Build Release APK
      run: gradle assembleRelease --parallel --build-cache
      
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: photo-classifier-app-release
        path: app/build/outputs/apk/release/*.apk
        retention-days: 30
        
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'
    
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: '8.0'
        cache-read-only: false
      
    - name: Build Release APK
      run: gradle assembleRelease --parallel --build-cache --configuration-cache
      
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: Rename APK
      run: |
        cd app/build/outputs/apk/release
        APK_FILE=$(ls -1 *.apk | head -1)
        mv "$APK_FILE" photo-classifier-app-${{ steps.get_version.outputs.VERSION }}.apk
      
    - name: Create Release and Upload APK
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ steps.get_version.outputs.VERSION }}
        draft: false
        prerelease: false
        body: |
          ## ç…§ç‰‡åˆ†ç±»ç®¡ç† ${{ steps.get_version.outputs.VERSION }}
          
          ### æ–°å¢åŠŸèƒ½ âœ¨
          - ğŸ“ **æ–‡ä»¶å¤¹ç®¡ç†å¢å¼º**ï¼šæ‹ç…§å‰å¯é€‰æ‹©ä¿å­˜æ–‡ä»¶å¤¹
          - ğŸ”„ **å¿«é€Ÿåˆ‡æ¢**ï¼šéšæ—¶åˆ‡æ¢æ–‡ä»¶å¤¹ï¼Œæ— éœ€é‡æ–°æ‹ç…§
          - â• **ä¸€é”®åˆ›å»º**ï¼šç‚¹å‡»"+"æŒ‰é’®å¿«é€Ÿåˆ›å»ºæ–°æ–‡ä»¶å¤¹
          - ğŸ’¾ **æ™ºèƒ½è®°å¿†**ï¼šè‡ªåŠ¨è®°ä½ä¸Šæ¬¡é€‰æ‹©çš„æ–‡ä»¶å¤¹
          - ğŸ’» **USBå¯¼å‡º**ï¼šç…§ç‰‡ä¿å­˜åœ¨ DCIM/PhotoClassifierï¼Œç”µè„‘å¯ç›´æ¥è®¿é—®
          
          ### æ ¸å¿ƒç‰¹æ€§ ğŸ¯
          - ğŸ“· ç›¸æœºæ‹ç…§åŠŸèƒ½
          - ğŸ“ æ–‡ä»¶å¤¹åˆ†ç±»ç®¡ç†
          - ğŸ–¼ï¸ ç…§ç‰‡æµè§ˆå’Œç®¡ç†
          - ğŸ—‘ï¸ åˆ é™¤å’Œç§»åŠ¨ç…§ç‰‡
          - âœ… æ”¯æŒ Android 9+
          
          ### å­˜å‚¨ä½ç½® ğŸ“
          ```
          å†…éƒ¨å­˜å‚¨/DCIM/PhotoClassifier/<æ–‡ä»¶å¤¹å>/
          ```
          
          ### å®‰è£…è¯´æ˜ ğŸ“¥
          1. ä¸‹è½½ `photo-classifier-app-${{ steps.get_version.outputs.VERSION }}.apk`
          2. åœ¨ Android è®¾å¤‡ä¸Šå®‰è£…
          3. æˆäºˆç›¸æœºå’Œå­˜å‚¨æƒé™
          4. å¼€å§‹ä½¿ç”¨ï¼
          
          ### ç³»ç»Ÿè¦æ±‚ ğŸ“±
          - Android 9.0 (API 28) åŠä»¥ä¸Š
          - ç›¸æœºæƒé™
          - å­˜å‚¨æƒé™
          
          ---
          
          ğŸ“– æŸ¥çœ‹å®Œæ•´æ–‡æ¡£ï¼š[README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
        files: |
          app/build/outputs/apk/release/photo-classifier-app-${{ steps.get_version.outputs.VERSION }}.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
